var module = {};
var pvjsSources;
function getUriParam(name) {

  // Thanks to http://stackoverflow.com/questions/11582512/how-to-get-uri-parameters-with-javascript
  // This will be replaced once we get the backend php to get the json

  var parameter = decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
  if (!!parameter) {
    return parameter;
  }
  else {
    return null;
  }
}

function getUriParamList() {
  uriParamList = {
    'svg-disabled': false,
    'gpml': null,
    'gpmlRev': 0,
    'creator': 'pathvisiojs-dev',
    'account': '',
    'branch': ''
  };

  Object.keys(uriParamList).forEach(function(element) {
    if (!!getUriParam(element)) {
      uriParamList[element] = getUriParam(element);
    }
    window.setTimeout(function() {
      $('#' + element).val(uriParamList[element]);
    }, 50)
  });

  return uriParamList;
}

function loadScripts(array, callback){  
  var loader = function(src,handler){  
    var script = document.createElement('script');  
    script.src = src;  
    script.onload = script.onreadystatechange = function(){  
      script.onreadystatechange = script.onload = null;  
      if(/MSIE ([6-9]+\.\d+);/.test(navigator.userAgent))window.setTimeout(function(){handler();},8,this);  
      else handler();  
    }  
    var head = document.getElementsByTagName('head')[0];  
    (head || document.body).appendChild( script );  
  };  
  (function(){  
    if(array.length!=0){  
      loader(array.shift(),arguments.callee);  
    }else{  
      callback && callback();  
    }  
  })();  
}

function updateParams(updatedParam) {
  var targetUri = currentUri + '?' + updatedParam.key + '=' + updatedParam.value;

  Object.keys(uriParamList).forEach(function(element) {
    if (element === updatedParam.key) {
      uriParamList[element] = updatedParam.value;
    }
    else {
      targetUri += '&' + element + '=' + uriParamList[element];
    }
  });

  location.href = targetUri;
}

function generateHtmlView(callback) {
  d3.html(srcDirectoryUri + 'pathvisiojs.html', function(html) {
    var svg = html.querySelector('#pathvisiojs-diagram');
    svg.setAttribute('style', 'display: none; ');
    svg.setAttribute('width', '500px');
    svg.setAttribute('height', '500px');

    var oSerializer = new XMLSerializer();
    pathvisioNS['tmp/pathvisiojs.html'] = oSerializer.serializeToString(html);
    callback();
  });
}

<<<<<<< HEAD
=======
function loadExtJsCss(callbackOutside) {
  async.parallel([
    function(callback) {
    loadJsCssFile(srcDirectoryUri + 'css/pathvisiojs.css', 'css', callback);
  },
  function(callback) {
    loadJsCssFile(srcDirectoryUri + 'css/annotation.css', 'css', callback);
  },
  function(callback) {
    loadJsCssFile(srcDirectoryUri + 'css/pan-zoom.css', 'css', callback);
  },
  function(callback) {
    loadScripts([
      srcDirectoryUri + 'js/pathvisiojs/pathvisio.js',
      srcDirectoryUri + 'js/pathvisiojs/utilities.js',
      srcDirectoryUri + 'js/pathvisiojs/data/data.js',
      srcDirectoryUri + 'js/pathvisiojs/data/bridgedb/bridgedb.js',
      srcDirectoryUri + 'js/pathvisiojs/data/bridgedb/data-sources.js',
      srcDirectoryUri + 'js/pathvisiojs/data/biopax/biopax.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/gpml.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/element.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/text.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/namespaces.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/biopax-ref.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/node/node.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/node/group-node.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/node/entity-node/entity-node.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/node/entity-node/data-node.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/node/entity-node/label.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/node/entity-node/shape.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/node/anchor.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/edge/edge.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/edge/interaction.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/edge/graphical-line.js',
      srcDirectoryUri + 'js/pathvisiojs/data/gpml/edge/point.js',
      srcDirectoryUri + 'js/pathvisiojs/view/view.js',
      srcDirectoryUri + 'js/pathvisiojs/view/annotation/annotation.js',
      srcDirectoryUri + 'js/pathvisiojs/view/annotation/citation.js',
      srcDirectoryUri + 'js/pathvisiojs/view/annotation/x-ref.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/pathway-diagram.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/path-finder.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/svg.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/grid.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/info-box.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/symbol.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/publication-xref.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/node.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/anchor.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/entity-node.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/path-shape.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/rounded-rectangle.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/rounded-rectangle-double.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/oval-double.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/complex.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/endoplasmic-reticulum.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/sarcoplasmic-reticulum.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/golgi-apparatus.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/mitochondria.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/arc.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/brace.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/grid-square.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/hexagon.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/mim-degradation.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/none.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/oval.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/pentagon.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/rectangle.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/path-shape/triangle.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/text.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/group-node.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/node/use-element.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/edge/edge.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/edge/graphical-line.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/edge/interaction.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/edge/marker.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/edge/point.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/edge/path-data.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/svg/edge/path.js',
      srcDirectoryUri + 'js/pathvisiojs/view/pathway-diagram/png/png.js'
    ],
    function(){
      callback(null);
    });
  }
  ],
  function(err, results){
    callbackOutside();
  })
}

>>>>>>> d52ce87c67b822846811c3c4d75fedf27fb6d735
var uriParamList = getUriParamList();

var hostname = decodeURI(window.location.hostname);

var currentUri = document.location;
var pathvisiojsRootDirectoryUri = document.location.pathname.split('test/compare.html')[0];
var srcDirectoryUri = (pathvisiojsRootDirectoryUri + 'src/');

/*********************************************
  Load UI for this test/dev comparison page 
/********************************************/

var pathvisiojs = pathvisiojs || {};
var pathvisioNS;
var gpmlUri;
window.onload = function() {
  if (uriParamList['svg-disabled']) {
    Modernizr.svg = false;
    $('#svg-disabled').prop('checked', true);
  }

  async.series([
    function(callback) {
      var gruntFileUri = '../Gruntfile.js'; // just for testing/development purposes
      loadScripts([gruntFileUri], function() {
        callback(null);
      });
    },
    function(callback) {
      pathvisioNS = [];
      generateHtmlView(function() {
        callback(null);
      });
    },
    function(callback) {
      var pvjsSourcesDev = pvjsSources.slice(1); //this file is only used in the build process

      // In dev mode, different servers will use different configs.
      // The code below sets this config file.
      // For production, we will use default.js for our default config settings and
      // optionally build other versions as needed if we need a built version that
      // doesn't use the config settings in default.js.
      var serverSpecificJsConfigFileName;
      var regDomainPattern = /^(?!:\/\/)([a-zA-Z0-9]+\.)?[a-zA-Z0-9][a-zA-Z0-9-]+\.[a-zA-Z]{2,6}?$/i
      var regexResult = regDomainPattern.exec(hostname);
      if (!!regexResult) {
        // www is the same as a bare domain for our purposes, e.g., www.example.org === example.org
        if (!!regexResult[1]) {
          serverSpecificJsConfigFileName = regexResult[0];
        }
        else {
          serverSpecificJsConfigFileName = 'www.' + regexResult[0];
        }
      }
      else { //if it's an IP address, just use localhost
        serverSpecificJsConfigFileName = 'localhost';
      }

      serverSpecificJsConfigFileName = strcase.paramCase(serverSpecificJsConfigFileName);
      pvjsSourcesDev[1] = 'config/' + serverSpecificJsConfigFileName + '.js';

      pvjsSourcesDev = pvjsSourcesDev.map(function(source) {
        return '../' + source;
      });

      loadScripts(pvjsSourcesDev, function() {
        callback(null);
      });
    }
  ],
  function(err) {
    // Specify an image for each semantic element you would like to customize.
    // If no image is specified for a semantic element, the default will be used.
    // You can use the same image for multiple semantic elements if you choose to,
    // but every semanticName must be unique.
 /*   var customSymbols = [
      {
        'semanticName': 'rectangle',
        'uri': srcDirectoryUri + 'shape-library/symbols/rectangle.svg'
      }
    ];
//*/
        console.log('pathvisiojs.config.bridgedbLinkOutsUriStub');
        console.log(pathvisiojs.config.bridgedbLinkOutsUriStub);
    var customMarkers = [
      {
        'semanticName': 'arrow',
        //'uri': 'http://wikipathways.org/skins/common/images/poweredby_mediawiki_88x31.png' // can use PNG or SVG
        'uri': srcDirectoryUri + 'shape-library/markers/arrow.svg'
      },
      {
        'semanticName': 'necessary-stimulation',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-necessary-stimulation.svg'
      },
      {
        'semanticName': 'binding',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-binding.svg'
      },
      {
        'semanticName': 'conversion',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-conversion.svg'
      },
      {
        'semanticName': 'stimulation',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-stimulation.svg'
      },
      {
        'semanticName': 'modification',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-modification.svg'
      },
      {
        'semanticName': 'catalysis',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-catalysis.svg'
      },
      {
        'semanticName': 'inhibition',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-inhibition.svg'
      },
      {
        'semanticName': 'cleavage',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-cleavage.svg'
      },
      {
        'semanticName': 'covalent-bond',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-covalent-bond.svg'
      },
      {
        'semanticName': 'transcription-translation',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-transcription-translation.svg'
      },
      {
        'semanticName': 'gap',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-gap.svg'
      },
      {
        'semanticName': 'inhibitory-activity',
        'uri': srcDirectoryUri + 'shape-library/markers/t-bar.svg'
      },
      {
        'semanticName': 'unspecified',
        'uri': srcDirectoryUri + 'shape-library/markers/none.svg'
      },
      {
        'semanticName': 'activity',
        'uri': srcDirectoryUri + 'shape-library/markers/arrow.svg'
      },
      {
        'semanticName': 'mim-branching-left',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-branching-left.svg'
      },
      {
        'semanticName': 'mim-branching-right',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-branching-right.svg'
      },
      {
        'semanticName': 'mim-necessary-stimulation',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-necessary-stimulation.svg'
      },
      {
        'semanticName': 'mim-binding',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-binding.svg'
      },
      {
        'semanticName': 'mim-conversion',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-conversion.svg'
      },
      {
        'semanticName': 'mim-stimulation',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-stimulation.svg'
      },
      {
        'semanticName': 'mim-modification',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-modification.svg'
      },
      {
        'semanticName': 'mim-catalysis',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-catalysis.svg'
      },
      {
        'semanticName': 'mim-inhibition',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-inhibition.svg'
      },
      {
        'semanticName': 'mim-cleavage',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-cleavage.svg'
      },
      {
        'semanticName': 'mim-covalent-bond',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-covalent-bond.svg'
      },
      {
        'semanticName': 'mim-transcription-translation',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-transcription-translation.svg'
      },
      {
        'semanticName': 'mim-gap',
        'uri': srcDirectoryUri + 'shape-library/markers/mim-gap.svg'
      },
      {
        'semanticName': 't-bar',
        'uri': srcDirectoryUri + 'shape-library/markers/t-bar.svg'
      },
      {
        'semanticName': 'none',
        'uri': srcDirectoryUri + 'shape-library/markers/none.svg'
      }
    ];

    // for element scaling, we are using the SVG terms for all graphical representations of pathways.
    // preserveAspectRatio refers to the vertical and horizontal alignment of the image.

    pathvisiojs.load({
      container: '#pathvisiojs-dev', //as of now, this can only be a CSS selector: http://www.w3.org/TR/CSS2/selector.html
      width: 400,
      height: 300,
      fitToContainer:true, //A fitToContainer value of false means that the diagram should be the size specified by the diagram creator, without any scaling (full size as per GPML width and height). A value of true means that diagram should be scaled down, if required, to fit entirely within the element specified by the container selector, while preserving aspect ratio. 
      data: uriParamList.gpml,
      //gpmlRev: uriParamList.gpmlRev,
      cssUri: srcDirectoryUri + 'css/pathway-diagram.css',
      customMarkers: customMarkers,
      //customSymbols: customSymbols,
      highlightNodes: [
        {'parameter': 'label', 'parameterValue': 'CRH', 'color': 'red'},
        {'parameter': 'xref', 'parameterValue': '8525,Entrez%20Gene', 'color': '#FF0000'}
      ],
      hiddenElements: [
        'find',
        'wikipathways-link'
      ]
    });
  });

  // test for whether uriParamList.gpml is a WikiPathways ID
  // If it is not a WikiPathways ID, the WikiPathways widget will not be able to load the pathway.
  if (uriParamList.gpml.indexOf('.gpml') === -1 && uriParamList.gpml.indexOf('.xml') === -1) {
    window.setTimeout(function() {
        $('#current-wikipathways-viewer').prepend('<iframe id="current-wiki-pathways-widget" src="http://www.wikipathways.org/wpi/PathwayWidget.php?id=' + uriParamList.gpml + '" width="500px" height="500px" />')
        }, 50);
  }
  else {
    console.warn('GPML data source specified is not a WP ID. WP widget cannot display this GPML data as a pathway image.');
  }
}


/* *******************
/* Until we finish automating the Grunt build process, we are manually getting the html template with this function.
/* *******************/

var getPathvisiojsHtmlTemplate = function() {
  var svg = d3.select('#pathvisiojs-diagram');
  svg.select('#viewport').selectAll('*').remove();
  var marker, oldMarkerId, newMarkerId;
  var markers = svg.selectAll('marker');
  markers.each(function() {
    marker = d3.select(this);
    oldMarkerId = marker.attr('id');
    newMarkerId = 'shape-library' + oldMarkerId.split('-shape-library')[1];
    marker.attr('id', newMarkerId);
  });

  var symbol, oldSymbolId, newSymbolId;
  var symbols = svg.selectAll('symbol');
  symbols.each(function() {
    symbol = d3.select(this);
    oldSymbolId = symbol.attr('id');
    newSymbolId = 'shape-library' + oldSymbolId.split('-shape-library')[1];
    symbol.attr('id', newSymbolId);
  });
  return d3.select('#pathvisiojs-container')[0][0];
}


