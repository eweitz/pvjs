<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <title>Pathvisiojs Simple Built Production Example</title>

  <!--
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" media="screen">
  <link rel="stylesheet" href="http://wikipathways.github.io/pathvisiojs/src/css/pathvisiojs.css" media="screen">
  <link rel="stylesheet" href="http://wikipathways.github.io/pathvisiojs/src/css/annotation.css" media="screen">
  <link rel="stylesheet" href="http://wikipathways.github.io/pathvisiojs/src/css/pan-zoom.css" media="screen">
  <link rel="stylesheet" href="http://wikipathways.github.io/pathvisiojs/src/css/pathway-diagram.css" media="screen">
  -->

  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" media="screen">
  <link rel="stylesheet" href="../src/css/pathvisiojs.css" media="screen">
  <link rel="stylesheet" href="../src/css/annotation.css" media="screen">
  <link rel="stylesheet" href="../src/css/pan-zoom.css" media="screen">
  <link rel="stylesheet" href="../src/css/pathway-diagram.css" media="screen">

  <!--[if lt IE 9]>
  <script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
  <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="../lib/es5-shim/es5-shim.js"></script>
  <script src="../lib/Xccessors/xccessors-standard.js"></script>

  <script>

    // IE8 only allows console.log when Developer Tools is open. This will prevent errors
    // from showing up if I use console.log without DevTools being open.
    // from http://stackoverflow.com/questions/3326650/console-is-undefined-error-for-internet-explorer

    /**
    * Protect window.console method calls, e.g. console is not defined on IE
    * unless dev tools are open, and IE doesn't define console.debug
    */
    (function() {
    if (!window.console) {
    window.console = {};
    }
    // union of Chrome, FF, IE, and Safari console methods
    var m = [
    "log", "info", "warn", "error", "debug", "trace", "dir", "group",
    "groupCollapsed", "groupEnd", "time", "timeEnd", "profile", "profileEnd",
    "dirxml", "assert", "count", "markTimeline", "timeStamp", "clear"
    ];
    // define undefined methods as noops to prevent errors
    for (var i = 0; i < m.length; i++) {
    if (!window.console[m[i]]) {
    window.console[m[i]] = function() {};
    }    
    } 
    })();
  </script>
  <![endif]-->


</head>

<body>
  <div id="body">
    <div id="header">
      <h1>Pathvisiojs Simple Built Production Example</h1>
    </div>
    <div id="main">
      <div id="production-container" style="width: 500px; height: 500px; border:1px solid black; ">
      </div>
    </div>
    <div id="footer">
      <p>(c) WikiPathways 2013</p>
    </div>
  </div>
  <!--
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/rgb-color/rgb-color.min.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/strcase/dist/strcase.min.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/async/lib/async.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/d3/d3.min.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/jquery/jquery.min.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/typeahead.js/dist/typeahead.min.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/modernizr/modernizr.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/screenfull/dist/screenfull.min.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/svg-pan-zoom/svg-pan-zoom.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/PathFinding.js/lib/pathfinding-browser.min.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/node-uuid/uuid.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/jsonld.js/js/jsonld.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/jsonld.js/js/Promise.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/lib/lib/jsonld.js/js/rdfa.js"></script>
  <script src="http://wikipathways.github.io/pathvisiojs/build/js/pathvisio.min.js"></script>
  -->
  <script src="../lib/rgb-color/rgb-color.min.js"></script>
  <script src="../lib/strcase/dist/strcase.min.js"></script>
  <script src="../lib/async/lib/async.js"></script>
  <script src="../lib/d3/d3.min.js"></script>
  <script src="../lib/jquery/jquery.min.js"></script>
  <script src="../lib/typeahead.js/dist/typeahead.min.js"></script>
  <script src="../lib/modernizr/modernizr.js"></script>
  <script src="../lib/svg-pan-zoom/svg-pan-zoom.js"></script>
  <script src="../lib/node-uuid/uuid.js"></script>
  <script src="../lib/jsonld.js/js/jsonld.js"></script>
  <script src="../lib/jsonld.js/js/Promise.js"></script>

  <script>

    /* *******************
    /* Get the desired GPML file URL or WikiPathways ID from the URL parameters.
    /* *******************/

    // If you want to the GPML file URL or WikiPathways ID you want to display, you can
    // hard code it as the data parameter in the pathvisiojs.load() function below

    function getUrlParam(name) {

      // Thanks to http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript
      // This will be replaced once we get the backend php to get the GPML

      var parameter = decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
      if (!!parameter) {
        return parameter;
      }
      else {
        return null;
      }
    }

    function getUrlParamList() {
      urlParamList = {
        'svg-disabled': false,
        'gpml': null,
        'gpmlRev': 0,
        'creator': 'pathvisiojs-dev',
        'account': '',
        'branch': ''
      };
      Object.keys(urlParamList).forEach(function(element) {
        if (!!getUrlParam(element)) {
          urlParamList[element] = getUrlParam(element);
        }
        window.setTimeout(function() {
          $('#' + element).val(urlParamList[element]);
        }, 50)
      });
      return urlParamList;
    }

    function loadJsCssFile(filename, filetype, callback){
      var fileref;
      if (filetype=='js') {
        fileref=document.createElement('script')
        fileref.setAttribute('type','text/javascript')
        fileref.setAttribute('src', filename)
      }
      else if (filetype=='css') {
        fileref=document.createElement('link')
        fileref.setAttribute('rel', 'stylesheet')
        fileref.setAttribute('type', 'text/css')
        fileref.setAttribute('href', filename)
      }
      if (typeof fileref!='undefined') {
        document.getElementsByTagName('head')[0].appendChild(fileref)
      }
      fileref.onload = function() {
        callback();
      }
    }

    function updateParams(updatedParam) {
      var targetUrl = currentUrl + '?' + updatedParam.key + '=' + updatedParam.value;

      Object.keys(urlParamList).forEach(function(element) {
        if (element === updatedParam.key) {
          urlParamList[element] = updatedParam.value;
        }
        else {
          targetUrl += '&' + element + '=' + urlParamList[element];
        }
      });

      location.href = targetUrl;
    }

    async.waterfall([
      function(callback) {
        var urlParamList = getUrlParamList();
        var currentUrl = document.location.origin + document.location.pathname;
        var hostname = decodeURI(window.location.hostname);
        var pathvisiojsRootDirectoryUrl = document.location.origin + document.location.pathname.split('test/compare.html')[0];
        var srcDirectoryUrl = (pathvisiojsRootDirectoryUrl + 'src/');

        var serverSpecificBuiltFileDirectory;
        var regDomainPattern = /^(?!:\/\/)([a-zA-Z0-9]+\.)?[a-zA-Z0-9][a-zA-Z0-9-]+\.[a-zA-Z]{2,6}?$/i
        var regexResult = regDomainPattern.exec(hostname);
        if (!!regexResult) {
          // www is the same as a bare domain for our purposes, e.g., www.example.org === example.org
          if (!!regexResult[1]) {
            serverSpecificBuiltFileDirectory = regexResult[0];
          }
          else {
            serverSpecificBuiltFileDirectory = 'www.' + regexResult[0];
          }
        }
        else { //if it's an IP address, just use localhost
          serverSpecificBuiltFileDirectory = 'localhost';
        }

        serverSpecificBuiltFileDirectory = '../build/' + strcase.paramCase(serverSpecificBuiltFileDirectory) + '/js/pathvisio.min.js';
        loadJsCssFile(serverSpecificBuiltFileDirectory, 'js', function() {
          callback(null, urlParamList);
        });
      },    
      function(urlParamList, callback) {
        /* *******************
        /* Load pathvisiojs
        /* *******************/

        pathvisiojs.load({
          container: '#production-container', //as of now, this can only be a CSS selector: http://www.w3.org/TR/CSS2/selector.html
          width: 400,
          height: 300,
          fitToContainer:true, //A fitToContainer value of false means that the diagram should be the size specified by the diagram creator, without any scaling (full size as per GPML width and height). A value of true means that diagram should be scaled down, if required, to fit entirely within the element specified by the container selector, while preserving aspect ratio. 
          data: urlParamList.gpml,
          //gpmlRev: urlParamList.gpmlRev,
          //cssUrl: srcDirectoryUrl + 'css/pathway-diagram.css',
          //customMarkers: customMarkers,
          //customSymbols: customSymbols,
          highlightNodes: [
            {'parameter': 'label', 'parameterValue': 'CRH', 'color': 'red'},
            {'parameter': 'xref', 'parameterValue': '8525,Entrez%20Gene', 'color': '#FF0000'}
          ],
          hiddenElements: [
            'find',
            'wikipathways-link'
          ]
        });

        callback(null);
      }    
    ]);
  </script>

</body>
